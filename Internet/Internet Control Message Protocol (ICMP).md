
The internet Control Message Protocol version 4 (ICMPv4):


helps [[Internet Protocol (IP)|IP]]v4 to **handle some errors** that may occur in the network-layer delivery
since it lacks  error-reporting and error-correcting mechanism




**FORMALLY beeing a NET LAYER PROTOCOL** it's messages are not passed directly to the [[Data Link layer(DLL)]] but first encapsulated inside a **IP datagram**


ICMP is **inside** IP (ICMP messages are encapsulated into the payload of an IP message) but at the same its on TOP of IP(ICMP messages contain part of the ip packet with an error) 
![[Pasted image 20240116112606.png]]
## ICMP Encapsulation 
All error messages contain a data section that includes:
![[Pasted image 20240116120451.png]]
- IP header of the original datagram (**that caused the error**)
- The first 8 bytes of data in that in that datagram provide information about the port numbers and sequence number (transport layer info) to inform the transport layer protocols(TCP or UPD) about the erro
  
  **ICMP forms an error packet** $\rightarrow$ encapsulated in a up DATAGRAM 





# ICMP Messages
ICMP does not correct errors, it only reports them 
![[Pasted image 20240116113301.png]]
![[Pasted image 20240116113150.png]]
### Error-reporting messages
report problems that a router or the destination host may encounter when it processes an IP packet always to the **source** since D and S ip are the only data there is in ip datagram 

### **rules for error-reporting messages** 
is not allowed ICMP message for :
- response to a datagram carrying an ICMP message
- for fragmented datagram that is not the first fragment
- for datagram having multicast address 
- for datagram having a special address such as 127.0.0.0
  
  ### Error Reporting messages
  
#### Destination Unreachable
![[Pasted image 20240116121353.png]]
###### Type(3)
- The most used error message.
- Generally, when a packet is dropped, an error message is returned through ICMP to the source.
- This message uses different codes (0 to 15) for the *reason*:
![[Pasted image 20240116121638.png]]
## Time Exceeded 
![[Pasted image 20240116121723.png]]
###### Type(11)
- code 0 $\rightarrow$ returned to the S_ip when TTL goes to 0
- code 1 $\rightarrow$ generated by the destination when some fragments are missing after the fragment reassembly timer expires
## Parameter Problem 
![[Pasted image 20240116122444.png]]
### type(12)
- code 0 $\rightarrow$ if the header of an IP datagram contains a malformed field (violate format), an ICMP message is generated, **with a pointer that points to the field of the header that generated the problem**
- code 1 $\rightarrow$ if an option is unknown or certain operation cannot be carried out
### Query messages (Request and Reply) 
help a host to get specific information from a router or another host.
- probe or test the liveliness of the host or router in the internet 
- find the RTT for an IP datagram between 2 devices
#### ICMP Query Messages
# Echo 
![[Pasted image 20240116122643.png]]
- A host/router send **echo request** message to another host or router 
- if is alive it responds with **echo reply** (ping)
- Reply replicates the same identifier
- Optional data: sender can add other data to the request message, which will be replicated in the reply message

##### Use cases
1. **main use** calculate RTT with ping
2.  can be also used to find the **Maximum Tranfer Unit** 
   - Send segment with certain size and D (don't fragment) 
   - command:
      `ping -D -s 1500 unipd.it` 
      to not fragment and set MTP 
 *note* that default is 56 BYTES which is actually 64 ICMP data bytes when combined with 8 bytes of the ICMP HEADER
      
     
   - if source gets ICMP not reachable with **code 4** decrease the MTU set
![[Pasted image 20240116123335.png]]
### Traceroute
discover the path from source to destination and make some measuremnt using the TTL and destination-unreachable 

plays with [[#Time Exceeded]] ICMP packets, 
that returns the server in wich TTL=0 

- first message is sent with TTL=1,2,3,4
     gaining **time-exceeded ICMP** server
- at some point the message reaches the destination host. wich generates a **destination-unreachable** ICMP message with **code 3** sent back to show the port number is not found 

![[Pasted image 20240116124725.png]]

notes:
- Is an application-layer program, but only the client program is needed, it's messages are **designed to never reach the destination host app layer**
- note that **when traceroute does not receive a response in 5 sec** it prints an asterisk to signify a problem 
   

  

 







